<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Go WebRTC P2P Chat</title>
</head>
<body>
  <h1>Video Chat</h1>

  <div>
    <video id="localVideo" autoplay playsinline muted style="width: 300px; border: 1px solid black;"></video>
    <video id="remoteVideo" autoplay playsinline style="width: 300px; border: 1px solid black;"></video>
  </div>

  <script>
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
  
    const roomID = "room1";
    const userID = crypto.randomUUID();

    console.log("My User ID is:", userID);

    const ws = new WebSocket("ws://localhost:8080/ws");
  
    let localStream;
    let remoteStream = new MediaStream();
    let peerConnection;
  
    const config = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" }
      ]
    };
  
    ws.onopen = () => {
      console.log("WebSocket connected");
      ws.send(JSON.stringify({ type: "join", roomID, senderID: userID }));
    };
  
    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);
  
      if (msg.senderID === userID) return; // Ignore our own messages
  
      switch (msg.type) {
        case "offer":
          await handleOffer(msg);
          break;
        case "answer":
          await handleAnswer(msg);
          break;
        case "ice-candidate":
          if (peerConnection) {
            peerConnection.addIceCandidate(new RTCIceCandidate(msg.candidate));
          }
          break;
      }
    };
  
    async function startMedia() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
      } catch (err) {
        console.error("Error accessing media devices.", err);
      }
    }
  
    function createPeerConnection(targetID) {
      peerConnection = new RTCPeerConnection(config);
  
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({
            type: "ice-candidate",
            targetID,
            senderID: userID,
            candidate: event.candidate
          }));
        }
      };
  
      peerConnection.ontrack = (event) => {
        event.streams[0].getTracks().forEach(track => {
          remoteStream.addTrack(track);
        });
        remoteVideo.srcObject = remoteStream;
      };
  
      localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
      });
    }
  
    async function makeOffer(targetID) {
      createPeerConnection(targetID);
  
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
  
      ws.send(JSON.stringify({
        type: "offer",
        offer,
        senderID: userID,
        targetID
      }));
    }
  
    async function handleOffer(msg) {
      createPeerConnection(msg.senderID);
      await peerConnection.setRemoteDescription(new RTCSessionDescription(msg.offer));
  
      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);
  
      ws.send(JSON.stringify({
        type: "answer",
        answer,
        senderID: userID,
        targetID: msg.senderID
      }));
    }
  
    async function handleAnswer(msg) {
      await peerConnection.setRemoteDescription(new RTCSessionDescription(msg.answer));
    }
  
    startMedia().then(() => {
      // ðŸŸ¡ Automatically make offer if another user is already in the room
      // For now, weâ€™ll simulate a delay to give others time to join
      setTimeout(() => {
        // ðŸ‘‡ Trigger offer to the other peer (assuming there's only 1 peer for now)
        const otherUserID = prompt("Enter target userID to connect to:");
        if (otherUserID) {
          makeOffer(otherUserID);
        }
      }, 2000);
    });
  </script>
  
</body>
</html>
